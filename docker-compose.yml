version: '3.8'

services:
 web:
  build:
   context: ./flask
  ports:
    - 3000:3000
  volumes:
    - ./flask:/workspace/flask
  depends_on:
    mysqldb:
      condition: service_healthy
  container_name: web

 mysqldb:
  image: mysql
  ports:
    - 33306:3306
  environment:
    MYSQL_ROOT_PASSWORD: root
    MYSQL_DATABASE: taipeibus
  healthcheck:
    test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
    timeout: 10s
    retries: 5
  volumes:
    - mysql:/var/lib/mysql
    - mysql_config:/etc/mysql
  container_name: db

 nginx:
  image: jonasal/nginx-certbot:4.0.0
  restart: unless-stopped
  env_file:
    - ./nginx/nginx-certbot.env
  ports:
    - 80:80
    - 443:443
  volumes:
    - nginx_secrets:/etc/letsencrypt
    - ./user_conf.d:/etc/nginx/user_conf.d
  depends_on:
    - web
  container_name: nginx
  
volumes:
  mysql:
  mysql_config:
  nginx_secrets: